<UserControl x:Class="VDLaser.Views.Controls.PlotterView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:VDLaser.ViewModels.Plotter;assembly=VDLaser.ViewModels"
             xmlns:local="clr-namespace:VDLaser.Converters"
             mc:Ignorable="d">
    <UserControl.InputBindings>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding SetOriginCommand}" />
    </UserControl.InputBindings>
    <Border ClipToBounds="True" BorderThickness="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <GroupBox Background="#FFE5E5E5" Header="Plotter preview" Style="{DynamicResource GroupBoxStyleVD}">
            <Grid Margin="5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="2*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="9*"/>
                    <RowDefinition Height="14*"/>
                    <RowDefinition Height="15"/>
                </Grid.RowDefinitions>
                <!-- StackPanel pour boutons -->
                <StackPanel Grid.Column="0" Orientation="Vertical" 
                            Margin="5,0,5,0" 
                            VerticalAlignment="Center" Height="230" Grid.RowSpan="2">
                    <Button Content="Center" 
                            Command="{Binding AutoCenterCommand}" 
                            ToolTip="Auto zoom"
                             Width="70"
                            Margin="0,0,0,5"/>
                    <Button Content="Set Origin" Command="{Binding SetOriginCommand}" 
                            ToolTip="Position actuelle comme origine WCS" 
                            Margin="0,0,0,5"/>
                    <Button Content="Reset"
                            Command="{Binding ResetViewCommand}"
                            ToolTip="Réinitialisation du graphe"
                            Width="70"
                            Margin="0"/>
                    <TextBlock Text="{Binding ToolPathGeometry.Figures.Count, StringFormat='Segments: {0}'}"
           Grid.Row="0" Grid.Column="0"
           Foreground="Black"
           HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0"/>
                    <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Vertical" Margin="5,0,5,0" Height="127">
                        <Button Margin="0,0,0,5" 
                        Width="60"
                        Content="{Binding IsSimulating,
                        Converter={StaticResource BooleanToStringConverter},
                        ConverterParameter=Stop|Start}"
                        Command="{Binding ToggleSimulationCommand}">
                        </Button>
                        <TextBlock Text="Simulation" Foreground="Black" Margin="0,5,0,0"/>
                        <Slider Minimum="0.5" Maximum="10" Value="{Binding SimulationSpeed}" 
            TickFrequency="0.5" IsSnapToTickEnabled="True" Margin="0"/>
                        <TextBlock Text="{Binding SimulationSpeed, StringFormat={}{0:F1}x}" 
               Foreground="Black" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding MachinepositionPointSize}" HorizontalAlignment="Center" Foreground="Black" Margin="0,5,0,0"/>

                        <CheckBox x:Name="ColorToggle" Content="Blanc" Margin="0" Width="54"/>
                        <TextBlock Text="{Binding MachinepositionPointSize}" HorizontalAlignment="Center" Foreground="Black" Margin="0,5,0,0"/>
                    </StackPanel>

                </StackPanel>
                <!-- Labels Y -->
                <ItemsControl Grid.Row="0" Grid.Column="1" ItemsSource="{Binding YAxisLabels}" HorizontalContentAlignment="Right" Grid.RowSpan="2">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="1"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding StringFormat={}{0:F0}}" VerticalAlignment="Center" Margin="0,0,5,0" 
                                       Foreground="CornflowerBlue" FontSize="10" FontWeight="Bold"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <!-- Labels X -->
                <ItemsControl Grid.Row="2" Grid.Column="2" ItemsSource="{Binding XAxisLabels}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="1"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" HorizontalAlignment="Center" Margin="0,5,0,0"
                                       Foreground="CornflowerBlue" FontSize="10" FontWeight="Bold"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <!-- Canvas principal -->
                <Grid Grid.Row="0" Grid.Column="2" x:Name="CanvasContainer" ClipToBounds="True" Grid.RowSpan="2" MinWidth="500">
                    <Grid.Background>
                        <VisualBrush TileMode="Tile" 
                                     Viewbox="0,0,1,1" 
                                     Viewport="0,0,10,10" 
                                     ViewportUnits="Absolute">
                            <VisualBrush.Visual>
                                <Rectangle x:Name="TileRect" Height="5" Width="5" Stroke="AliceBlue" StrokeThickness="0.1">
                                    <Rectangle.Style>
                                        <Style TargetType="Rectangle">
                                            <Setter Property="Fill" Value="Black"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsChecked, ElementName=ColorToggle}" Value="True">
                                                    <Setter Property="Fill" Value="White"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Rectangle.Style>
                                </Rectangle>
                            </VisualBrush.Visual>
                        </VisualBrush>
                    </Grid.Background>
                    <Canvas x:Name="ViewportCanvas" Grid.Row="0"
                Loaded="ViewportCanvas_Loaded"
                SizeChanged="ViewportCanvas_SizeChanged"
                MouseWheel="ViewportCanvas_MouseWheel"
                MouseLeftButtonDown="ViewportCanvas_MouseLeftButtonDown"
                MouseMove="ViewportCanvas_MouseMove"
                MouseLeftButtonUp="ViewportCanvas_MouseLeftButtonUp"
                RenderTransformOrigin="0,0" Grid.RowSpan="2"
                            SnapsToDevicePixels="False"
                            UseLayoutRounding="False"
                            Background="Transparent">
                        <Canvas.Style>
                            <Style TargetType="Canvas">
                                <Setter Property="RenderOptions.EdgeMode" Value="Aliased" />
                                <Setter Property="RenderOptions.BitmapScalingMode" Value="Linear" />

                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding Viewport.IsInteracting}" Value="True" />
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="CacheMode">
                                            <Setter.Value>
                                                <BitmapCache EnableClearType="False" RenderAtScale="1" />
                                            </Setter.Value>
                                        </Setter>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Canvas.Style>
                        <Canvas.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform
                        ScaleX="{Binding Viewport.Scale, Mode=OneWay}"
                        ScaleY="{Binding Viewport.Scale,
                                    Converter={StaticResource NegativeConverter},  
                                    Mode=OneWay}" />
                                <TranslateTransform
                        X="{Binding Viewport.TranslationX, Mode=OneWay}"
                        Y="{Binding Viewport.TranslationY, Mode=OneWay}" />
                            </TransformGroup>
                        </Canvas.RenderTransform>
                        
                        <!-- highLight -->
                        <Ellipse Width="6" Height="6" 
         Fill="Red" 
         Stroke="White" 
         StrokeThickness="1"
         IsHitTestVisible="False"
         Visibility="{Binding HighlightPoint, Converter={StaticResource NullToVisibilityConverter}}">
                            <Ellipse.RenderTransform>
                                <TranslateTransform X="{Binding HighlightPoint.X}" 
                            Y="{Binding HighlightPoint.Y}" />
                            </Ellipse.RenderTransform>
                            <Ellipse.Margin>-3,-3,0,0</Ellipse.Margin>
                        </Ellipse>
                        <Path
                            Data="{Binding HighlightSegmentGeometry}"
                            Stroke="Red"
                            StrokeThickness="2"
                            StrokeDashArray="2 2"
                            IsHitTestVisible="False"/>
                        <!-- Bounding box -->
                        <Path Data="{Binding BoundingBoxGeometry}"
                              Stroke="Yellow"
                              StrokeThickness="1"
                              StrokeDashArray="4 2"
                              Opacity="0.6"
                              Panel.ZIndex="25"
                              IsHitTestVisible="False"/>
                        <!-- Rapid path -->
                        <Path Data="{Binding RapidPathGeometry}" 
                            Stroke="Gray" 
                            StrokeThickness="{Binding IsInteracting, Converter={StaticResource ThicknessConverter}}"
                            StrokeDashArray="2,2"
                            Panel.ZIndex="10"
                              IsHitTestVisible="False"/>
                        <!-- Tool path -->
                        <Path Data="{Binding EngravePathGeometry}" 
              Stroke="DodgerBlue" 
              StrokeThickness="1"
              StrokeStartLineCap="Round" 
              StrokeEndLineCap="Round" 
              Panel.ZIndex="10"
              SnapsToDevicePixels="True"
                              IsHitTestVisible="False"/>
                        <!-- Triangle pour simulation (tool head) -->
                        <Polygon Points="-5,-3 0,0 -5,3" Fill="Green" Panel.ZIndex="20">
                            <Polygon.RenderTransform>
                                <MatrixTransform x:Name="ToolMatrixTransform" />
                            </Polygon.RenderTransform>
                        </Polygon>
                        <!-- Cercle bleu pour position réelle de la machine (corrigé) -->
                        <Ellipse Width="{Binding MachinePositionPointSize}" Height="{Binding MachinePositionPointSize}" Fill="{Binding LaserHeadBrush}" Opacity="0.8" Panel.ZIndex="15"
                 Canvas.Left="{Binding MachinePositionPoint.X, Converter={StaticResource OffsetConverter}, ConverterParameter=0}"
                 Canvas.Top="{Binding MachinePositionPoint.Y, Converter={StaticResource OffsetConverter}, ConverterParameter=-2}" />
                        <Ellipse Width="6" Height="6" Fill="Yellow" Stroke="Red" StrokeThickness="1"
         Canvas.Left="{Binding HighlightPoint.X, Converter={StaticResource OffsetConverter}, ConverterParameter=-3}"
         Canvas.Top="{Binding HighlightPoint.Y, Converter={StaticResource OffsetConverter}, ConverterParameter=-3}"
         Panel.ZIndex="100">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HighlightPoint}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                    </Canvas>
                </Grid>
            </Grid>
        </GroupBox>
    </Border>
</UserControl>